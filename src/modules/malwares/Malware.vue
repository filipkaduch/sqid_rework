<template>
  <app-box class="w-100 h-100" padding-bottom="S">
    <app-box v-if="isLoading" class="h-100">
      <app-loader class="loader-position" />
    </app-box>
    <app-box v-else-if="malwareComputed" class="w-100">
      <app-box flex-type="row" align="space-between" :class="{'fixed-header': fullscreen}">
        <app-text v-if="malwareComputed[malwarePropertyTypes.HAS_NAME]" variant="app-headline3" color="display-content-600" class="cursor-pointer">
          {{ `${malwareComputed[malwarePropertyTypes.HAS_NAME]}`}} <small v-if="malwareComputed[malwarePropertyTypes.HAS_VERSION]">
          {{ malwareComputed[malwarePropertyTypes.HAS_VERSION] }}</small>  {{ `(${malwareComputed.id})` }}</app-text>
        <app-tooltip>
          <template #icon>
            <app-btn variant="ghost" icon-only @click="fullScreen">
              <template #icon>
                <app-icon :name="fullscreen ? 'app-icon-close' : 'app-fullscreen'" fill="display-content-600" />
              </template>
            </app-btn>
          </template>
          <template #tooltip>
            {{ $t('t_fullscreen') }}
          </template>
        </app-tooltip>
      </app-box>
      <app-box>
        <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_ALIASES]" padding-top="XS" class="w-100">
          <ul class="list-inline line-separated">
            <li class="list-inline-item" v-for="alias in malwareComputed[malwarePropertyTypes.HAS_ALIASES]" :key="alias">{{ alias }}</li>
          </ul>
        </app-box>
        <app-box padding-bottom="M">
          <app-text variant="subheadlineRegular" v-if="malwareComputed[malwarePropertyTypes.WAS_CREATED] || malwareComputed[malwarePropertyTypes.WAS_LAST_MODIFIED]">
            <b>{{ $t('entity.created') }}</b>{{ malwareComputed[malwarePropertyTypes.WAS_CREATED] }} | <b>{{ $t('entity.modified') }}</b>{{ malwareComputed[malwarePropertyTypes.WAS_LAST_MODIFIED] }}
          </app-text>
        </app-box>
      </app-box>
      <app-box v-if="malwareComputed.datatypes" flex-type="row" border-top="box" padding-top="S">
        <app-text class="mr-1" variant="app-paragraphLarge"><b>{{ `${$t('entity.propertyDatatypeLabelMalware')} `}}</b></app-text>
        <app-text v-for="(datatype, index) in malwareComputed.datatypes" variant="dataCaption">
        {{ `${objectCaseMapper(datatype, objectCaseStyles.SENTENCE_CASE)}${index + 1 !== malwareComputed.datatypes.length ? '|' : ''}` }}</app-text>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_DOMAIN]" flex-type="row" border-top="box" padding-top="S">
        <app-text class="mr-1" variant="app-paragraphLarge"><b>{{ $t('entity.domain') }}</b></app-text>
        <app-text variant="dataCaption">{{ malwareComputed[malwarePropertyTypes.HAS_DOMAIN] }}</app-text>
      </app-box>
        <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_URL]" flex-type="row">
            <app-text class="mr-1" variant="app-paragraphLarge"><b>{{ $t('entity.originalUrl') }}</b></app-text>
            <app-text variant="dataCaption"><a target="_blank" :href="malwareComputed[malwarePropertyTypes.HAS_URL]">{{ malwareComputed[malwarePropertyTypes.HAS_URL] }}</a></app-text>
        </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_PLATFORMS]" flex-type="row" align-y="center">
        <app-text class="mr-1" variant="app-paragraphLarge"><b>{{ `${$t('entity.platforms')} `}}</b></app-text>
        <app-inline gap="M" align-y="center"><app-text v-for="platform in malwareComputed[malwarePropertyTypes.HAS_PLATFORMS]" variant="dataCaption">
          {{ platform }} <app-icon :name="getPlatformIcon(platform)" fill="display-content-600" /></app-text>
        </app-inline>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_CONTRIBUTORS]" flex-type="row" align-y="center">
        <app-text class="mr-1" variant="app-paragraphLarge"><b>{{ `${$t('entity.contributors')} `}}</b></app-text>
        <app-inline gap="XS" align-y="center"><app-text v-for="(contributor, index) in malwareComputed[malwarePropertyTypes.HAS_CONTRIBUTORS]" variant="dataCaption">
          {{ `${contributor}${index + 1 !== malwareComputed[malwarePropertyTypes.HAS_CONTRIBUTORS]?.length ? ', ' : ''}` }} </app-text>
        </app-inline>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_PERMISSIONS_REQUIRED]" flex-type="row" align-y="center">
        <app-text class="mr-1" variant="app-paragraphLarge"><b>{{ `${$t('entity.permissions')} `}}</b></app-text>
        <app-inline gap="XS" align-y="center"><app-text v-for="(perm, index) in malwareComputed[malwarePropertyTypes.HAS_PERMISSIONS_REQUIRED]" variant="dataCaption">
          {{ `${perm}${index + 1 !== malwareComputed[malwarePropertyTypes.HAS_PERMISSIONS_REQUIRED].length ? ', ' : ''}` }} </app-text>
        </app-inline>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_SYSTEM_REQUIREMENTS]" flex-type="row" align-y="center">
        <app-text class="mr-1" variant="app-paragraphLarge"><b>{{ `${$t('entity.requirements')} `}}</b></app-text>
        <app-inline gap="XS" align-y="center"><app-text v-for="(sys, index) in malwareComputed[malwarePropertyTypes.HAS_SYSTEM_REQUIREMENTS]" variant="dataCaption">
          {{ `${sys}${index + 1 !== malwareComputed[malwarePropertyTypes.HAS_SYSTEM_REQUIREMENTS]?.length ? ', ' : ''}` }} </app-text>
        </app-inline>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_DATA_SOURCES]">
        <app-text class="mr-1" variant="app-paragraphLarge"><b>{{ `${$t('entity.dataSources')} `}}</b></app-text>
        <app-text v-for="(dataSource, index) in malwareComputed[malwarePropertyTypes.HAS_DATA_SOURCES]" variant="dataCaption">
          {{ `${dataSource}${index + 1 !== malwareComputed[malwarePropertyTypes.HAS_DATA_SOURCES]?.length ? ', ' : ''}` }} </app-text>
      </app-box>
      <app-box border-bottom="box" padding-bottom="S"/>
      <app-text v-if="malwareComputed[malwarePropertyTypes.IS_SUBTECHNIQUE] && malwareComputed[malwarePropertyTypes.IS_SUBTECHNIQUE_OF]">
        <b>{{ $t('entity.subtechnique') }}</b>{{ `${$t('entity.superClasses', {instance: malwareComputed[malwarePropertyTypes.HAS_NAME]})}: ` }}<b><app-link :malware-id="malwareComputed[malwarePropertyTypes.IS_SUBTECHNIQUE_OF].subtechniqueOf" /></b>
      </app-text>
      <app-box padding-top="M">
        <app-text variant="app-paragraphLarge"><b>{{ $t('entity.description') }}</b></app-text>
        <app-text variant="app-paragraphLarge">
          <template v-for="(word, index) in descWords" :key="index">
            <template v-if="isMarkdownLink(word)">
              <app-link :malware-id="/^[a-zA-Z]/.test(getLinkUrl(word)) ? getLinkUrl(word) : null" :text="getLinkText(word)" @new-query="newQueryAction"></app-link>
            </template>
            <template v-else>
              {{ word }}
            </template>
          </template>
        </app-text>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_DETECTION]" padding-top="M">
          <app-text variant="app-paragraphLarge"><b>{{ $t('entity.detection') }}</b></app-text>
          <template v-for="(word, index) in detectionWords" :key="index">
              <template v-if="isMarkdownLink(word)">
                  <app-link :malware-id="/^[a-zA-Z]/.test(getLinkUrl(word)) ? getLinkUrl(word) : null" :text="getLinkText(word)" @new-query="newQueryAction"></app-link>
              </template>
              <template v-else>
                  {{ word }}
              </template>
          </template>
          <app-text variant="app-paragraphLarge">
              {{ malwareComputed[malwarePropertyTypes.HAS_DETECTION] }}
          </app-text>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.USES_TECHNIQUE]?.length > 0" padding-top="M">
        <app-box class="collapse-header" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
          <app-text variant="app-paragraphLarge"><b>{{ $t('entity.techniques') }}</b></app-text>
          <app-btn variant="ghost" icon-only @click="collapses[malwarePropertyTypes.USES_TECHNIQUE] = !collapses[malwarePropertyTypes.USES_TECHNIQUE]">
            <template #icon>
              <app-icon :name="collapses[malwarePropertyTypes.USES_TECHNIQUE] ? 'app-chevron-top-pull' : 'app-chevron-down-pull'" fill="display-content-600" />
            </template>
          </app-btn>
        </app-box>
        <app-collapse :is-open="collapses[malwarePropertyTypes.USES_TECHNIQUE]" class="mt-2">
          <app-box class="collapse-header" padding-x="S" padding-y="XS" border-radius="basic" align-y="center">
            <app-scroll-table :items="malwareComputed[malwarePropertyTypes.USES_TECHNIQUE]" @new-query="newQueryAction"/>
          </app-box>
        </app-collapse>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.USES_SOFTWARE]?.length > 0" padding-top="M">
        <app-box class="collapse-header" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
          <app-text variant="app-paragraphLarge"><b>{{ $t('entity.softwares') }}</b></app-text>
          <app-btn variant="ghost" icon-only @click="collapses[malwarePropertyTypes.USES_SOFTWARE] = !collapses[malwarePropertyTypes.USES_SOFTWARE]">
            <template #icon>
              <app-icon :name="collapses[malwarePropertyTypes.USES_SOFTWARE] ? 'app-chevron-top-pull' : 'app-chevron-down-pull'" fill="display-content-600" />
            </template>
          </app-btn>
        </app-box>
        <app-collapse :is-open="collapses[malwarePropertyTypes.USES_SOFTWARE]" class="mt-2">
          <app-box class="collapse-header w-100" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
            <app-scroll-table :items="malwareComputed[malwarePropertyTypes.USES_SOFTWARE]" class="w-100" @new-query="newQueryAction"/>
          </app-box>
        </app-collapse>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.MITIGATES]?.length > 0" padding-top="M">
        <app-box class="collapse-header" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
          <app-text variant="app-paragraphLarge"><b>{{ $t('entity.mitigates') }}</b></app-text>
          <app-btn variant="ghost" icon-only @click="collapses[malwarePropertyTypes.MITIGATES] = !collapses[malwarePropertyTypes.MITIGATES]">
            <template #icon>
              <app-icon :name="collapses[malwarePropertyTypes.MITIGATES] ? 'app-chevron-top-pull' : 'app-chevron-down-pull'" fill="display-content-600" />
            </template>
          </app-btn>
        </app-box>
        <app-collapse :is-open="collapses[malwarePropertyTypes.MITIGATES]" class="mt-2">
          <app-box class="collapse-header w-100" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
            <app-scroll-table :items="malwareComputed[malwarePropertyTypes.MITIGATES]" class="w-100" @new-query="newQueryAction"/>
          </app-box>
        </app-collapse>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_SUBTECHNIQUE]?.length > 0" padding-top="M">
        <app-box class="collapse-header" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
          <app-text variant="app-paragraphLarge"><b>{{ $t('entity.relatedSubtechniques') }}</b></app-text>
          <app-btn variant="ghost" icon-only @click="collapses[malwarePropertyTypes.HAS_SUBTECHNIQUE] = !collapses[malwarePropertyTypes.HAS_SUBTECHNIQUE]">
            <template #icon>
              <app-icon :name="collapses[malwarePropertyTypes.HAS_SUBTECHNIQUE] ? 'app-chevron-top-pull' : 'app-chevron-down-pull'" fill="display-content-600" />
            </template>
          </app-btn>
        </app-box>
        <app-collapse :is-open="collapses[malwarePropertyTypes.HAS_SUBTECHNIQUE]" class="mt-2">
          <app-box class="collapse-header w-100" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
            <app-scroll-table :items="malwareComputed[malwarePropertyTypes.HAS_SUBTECHNIQUE]" class="w-100" @new-query="newQueryAction"/>
          </app-box>
        </app-collapse>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_MITIGATORS]?.length > 0" padding-top="M">
        <app-box class="collapse-header" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
          <app-text variant="app-paragraphLarge"><b>{{ $t('entity.mitigators') }}</b></app-text>
          <app-btn variant="ghost" icon-only @click="collapses[malwarePropertyTypes.HAS_MITIGATORS] = !collapses[malwarePropertyTypes.HAS_MITIGATORS]">
            <template #icon>
              <app-icon :name="collapses[malwarePropertyTypes.HAS_MITIGATORS] ? 'app-chevron-top-pull' : 'app-chevron-down-pull'" fill="display-content-600" />
            </template>
          </app-btn>
        </app-box>
        <app-collapse :is-open="collapses[malwarePropertyTypes.HAS_MITIGATORS]" class="mt-2">
          <app-box class="collapse-header w-100" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
            <app-scroll-table :items="malwareComputed[malwarePropertyTypes.HAS_MITIGATORS]" class="w-100" @new-query="newQueryAction"/>
          </app-box>
        </app-collapse>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.USED_IN_TACTIC]?.length > 0" padding-top="M">
        <app-box class="collapse-header" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
          <app-text variant="app-paragraphLarge"><b>{{ $t('entity.superTactics') }}</b></app-text>
          <app-btn variant="ghost" icon-only @click="collapses[malwarePropertyTypes.USED_IN_TACTIC] = !collapses[malwarePropertyTypes.USED_IN_TACTIC]">
            <template #icon>
              <app-icon :name="collapses[malwarePropertyTypes.USED_IN_TACTIC] ? 'app-chevron-top-pull' : 'app-chevron-down-pull'" fill="display-content-600" />
            </template>
          </app-btn>
        </app-box>
        <app-collapse :is-open="collapses[malwarePropertyTypes.USED_IN_TACTIC]" class="mt-2">
          <app-box class="collapse-header w-100" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
            <app-scroll-table :items="malwareComputed[malwarePropertyTypes.USED_IN_TACTIC]" class="w-100" @new-query="newQueryAction"/>
          </app-box>
        </app-collapse>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_DEFENSES_BY_PASSED]?.length > 0" padding-top="M">
        <app-box class="collapse-header" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
          <app-text variant="app-paragraphLarge"><b>{{ $t('entity.defensesByPassed') }}</b></app-text>
          <app-btn variant="ghost" icon-only @click="collapses[malwarePropertyTypes.HAS_DEFENSES_BY_PASSED] = !collapses[malwarePropertyTypes.HAS_DEFENSES_BY_PASSED]">
            <template #icon>
              <app-icon :name="collapses[malwarePropertyTypes.HAS_DEFENSES_BY_PASSED] ? 'app-chevron-top-pull' : 'app-chevron-down-pull'" fill="display-content-600" />
            </template>
          </app-btn>
        </app-box>
        <app-collapse :is-open="collapses[malwarePropertyTypes.HAS_DEFENSES_BY_PASSED]" class="mt-2">
          <app-box class="collapse-header w-100" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
            <app-scroll-table :items="malwareComputed[malwarePropertyTypes.HAS_DEFENSES_BY_PASSED]" class="w-100" @new-query="newQueryAction"/>
          </app-box>
        </app-collapse>
      </app-box>
      <app-box v-if="malwareComputed[malwarePropertyTypes.HAS_RELATIONSHIP_CITATIONS]?.length > 0" padding-top="M" padding-bottom="M">
          <app-box class="collapse-header" padding-x="S" padding-y="XS" border-radius="basic" flex-type="row" align="space-between" align-y="center">
              <app-text variant="app-paragraphLarge"><b>{{ $t('entity.citations') }}</b></app-text>
              <app-btn variant="ghost" icon-only @click="collapses[malwarePropertyTypes.HAS_RELATIONSHIP_CITATIONS] = !collapses[malwarePropertyTypes.HAS_RELATIONSHIP_CITATIONS]">
                  <template #icon>
                      <app-icon :name="collapses[malwarePropertyTypes.HAS_RELATIONSHIP_CITATIONS] ? 'app-chevron-top-pull' : 'app-chevron-down-pull'" fill="display-content-600" />
                  </template>
              </app-btn>
          </app-box>
          <app-collapse :is-open="collapses[malwarePropertyTypes.HAS_RELATIONSHIP_CITATIONS]" class="mt-2">
              <app-box class="collapse-header" padding-x="S" padding-y="XS" border-radius="basic" align="space-between" align-y="center">
                  <app-scroll-table :items="malwareComputed[malwarePropertyTypes.HAS_RELATIONSHIP_CITATIONS]" />
              </app-box>
          </app-collapse>
      </app-box>
    </app-box>
  </app-box>
</template>

<script lang="ts">
import {computed, defineComponent, reactive, ref, toRefs, watch} from "vue";
import AppLoader from "@/components/main/loader/AppLoader.vue";
import {useMalwaresStore} from "@/modules/malwares/store/malwaresStore";
import {malwarePropertyTypes, getPlatformIcon} from "@/api/malwares/malwares";
import {objectCaseMapper, objectCaseStyles} from "@/util/objectCaseMapper";
import AppPaginator from "@/components/design/AppPaginator.vue";
import AppScrollTable from "@/components/design/AppScrollTable.vue";
import {getName} from "@/api/malwares/sparql";
import {useQueriesStore} from "@/modules/queries/store/queriesStore";

export default defineComponent({
  name: 'Malware',
  computed: {
    malwarePropertyTypes() {
      return malwarePropertyTypes
    }
  },
  components: {AppScrollTable, AppPaginator, AppLoader},
  props: {
    malwareId: {
      type: String,
      default: null
    },
    queryId: {
      type: String,
      default: null
    }
  },
  emits: ['fullscreen', 'newQuery'],
  setup(props, {emit}) {
    const isLoading = computed(() => useMalwaresStore().malwares[props.malwareId]?.loading ?? true);
    const malwareComputed = computed(() => useMalwaresStore().malwares[props.malwareId]);
    const malwareDescription = ref(null);
    const state = reactive({
      collapses: {
        [malwarePropertyTypes.HAS_RELATIONSHIP_CITATIONS]: false,
        [malwarePropertyTypes.USES_TECHNIQUE]: false,
        [malwarePropertyTypes.USES_SOFTWARE]: false,
        [malwarePropertyTypes.MITIGATES]: false,
        [malwarePropertyTypes.HAS_MITIGATORS]: false,
        [malwarePropertyTypes.USED_IN_TACTIC]: false,
        [malwarePropertyTypes.HAS_DEFENSES_BY_PASSED]: false
      },
      fullscreen: false
    });
    const fullScreen = () => {
      state.fullscreen = !state.fullscreen;
      emit('fullscreen');
    };

    const newQueryAction = () => {
      state.fullscreen = false;
      emit('newQuery');
    };

    watch(isLoading, (val) => {
      if (!val) {
        emit('newQuery');
      }
    });

    const descWords = computed(() => malwareComputed.value?.[malwarePropertyTypes.HAS_DESCRIPTION]?.split(/(\[[^\]]+\]\([^)]+\))/) ?? []);
    const detectionWords = computed(() => malwareComputed.value?.[malwarePropertyTypes.HAS_DETECTION]?.split(/(\[[^\]]+\]\([^)]+\))/) ?? []);

    const getTextAfterLastSlash = (url: string) => {
      const parts = url.split('/');
      return parts[parts.length - 1];
    }
    const getLinkText = (word: string) => {
      // @ts-ignore
      return word.match(/\[([^\]]+)\]/)[1];
    };

    const getLinkUrl = (word: string) => {
      const textAfterSlash = getTextAfterLastSlash(word);
      return textAfterSlash.substring(0, textAfterSlash.length - 1);
    };

    const isMarkdownLink = (word: string) => {
      return /\[.*\]\(.*\)/.test(word);
    };

    watch(() => props.malwareId, async(val) => {
      if (val) {
        useMalwaresStore().malwares[val].loading = true;
        await useMalwaresStore().updateMalwareData(val);
        const toSliceName = await getName(val);
        // @ts-ignore
        useQueriesStore().queries.find((query) => query.id === props.queryId).name = toSliceName.slice(1, -1);
        useMalwaresStore().malwares[val].loading = false;
      }
    }, {immediate: true});
    return {
      isLoading,
      malwareComputed,
      objectCaseStyles,
      getPlatformIcon,
      fullScreen,
      objectCaseMapper,
      newQueryAction,
      ...toRefs(state),
      malwareDescription,
      descWords,
      detectionWords,
      getLinkUrl,
      getLinkText,
      isMarkdownLink
    }
  }
});
</script>
<style lang="scss" scoped>
.collapse-header {
  background-color: map-get($app-colors, 'separate-content-100');
}
.desc-link {
  text-decoration: underline;
}
.fixed-header {
  position: -webkit-sticky; /* Safari */
  position: sticky;
  top: 0;
  padding-top: 16px;
  padding-bottom: 16px;
  background-color: map-get($app-colors, 'separate-content-0');
  width: 100%;
}
</style>
