import {EntityId, SparqlBinding, SparqlResult} from "@/api/wikidata/types";
import {sparqlRequest} from "@/api/wikidata";
import {feiOntologyEndpoint, localSparqlEndpoint, rdfSchema, rdfSchemaSyntax} from "@/api/endpoints";
import {MalwareBinding, MalwareResult} from "@/api/malwares/types";
import {malwareSparqlRequest} from "@/api/malwares/index";
import {entityValue, sparqlQuery} from "@/api/wikidata/sparql";
import {extractId, malwarePropertyEndpointsMap, omitTypes} from "@/api/malwares/malwares";
import {MappedInfo} from "@/modules/malwares/store/malwaresStore";
import {DATA_SOURCES} from "@/util/consts/dataSources";

export const getTechniquesRelationsQuery = async(): Promise<SparqlBinding[]> => {
  const response = await sparqlRequest(localSparqlEndpoint,
      'SELECT ?s ?p ?o WHERE { ?s ?p ?o}');
  return response.results.bindings;
};

export const searchForPropertyValue = async(property: string, endpoint: string, malwareId: string) => {
  if (!omitTypes.includes(property)) {
    const response = await sparqlRequest(localSparqlEndpoint, `
  SELECT ?property ?value
      WHERE {
    <${endpoint}${malwareId}> ?property ?value.
    FILTER (regex(?property, "${property}", "i"))
  }`);
    return response;
  }
  return;
};

export const getName = async(malwareId: string): Promise<string> => {
  const response = await sparqlRequest(localSparqlEndpoint, `
    SELECT ?name
    WHERE {
      <${feiOntologyEndpoint}${malwareId}> <${feiOntologyEndpoint}hasName> ?name .
    }
  `);
  // @ts-ignore
  if (response[0]) {
    // @ts-ignore
    return response[0].name;
  }
  return '';
};

export const getSubtechniques = async(techniqueId: string): Promise<SparqlResult> => {
  const response = await sparqlRequest(localSparqlEndpoint, `
    SELECT ?entity WHERE {
      ?entity <${feiOntologyEndpoint}hasId> ?id .
      FILTER regex(?id, "^${techniqueId}.")
    }
  `);
  return response;
};

export const getRelations = async(techniqueId: string, property: string): Promise<SparqlResult> => {
  const response = await sparqlRequest(localSparqlEndpoint, `
    SELECT ?entity WHERE {
      ?entity <${feiOntologyEndpoint}${property}> ?id .
      FILTER regex(str(?id), "${techniqueId}")
    }
  `);
  return response;
};

export const searchForEntities = async(search: string) => {
  const response = await sparqlRequest(localSparqlEndpoint,`
        SELECT DISTINCT ?entity ?property ?value
    WHERE { 
      ?entity ?property ?value .
        FILTER (regex(?value, "${search}", "i") && !regex(?value, "^http://")) .
      FILTER (?property = <${feiOntologyEndpoint}hasName> ||
              ?property = <${rdfSchemaSyntax}hasDescription> ||
              ?property = <${feiOntologyEndpoint}hasAliases>)
      ?entity ?property ?filterValue .
    } LIMIT 10`);
  return response;
};

export const getMalwareProperties = async(malwareId: string) => {
  const response = await sparqlRequest(localSparqlEndpoint,`
          SELECT ?property ?value WHERE {
    <${feiOntologyEndpoint}${malwareId}> ?property ?value.
  }`);
  return response;
};

export const getMalwarePropertyDefinition = async(property: string) => {
  const response = await(sparqlRequest(localSparqlEndpoint, `
  SELECT ?definition WHERE {
    <${malwarePropertyEndpointsMap(property)}${property}> ?value ?definition .
  }`));
  return response;
};

export const getById = async(): Promise<MalwareResult> => {
  const response = await malwareSparqlRequest(localSparqlEndpoint, `SELECT ?s ?p ?o WHERE {?s ?p <http://www.w3.org/2002/07/owl#FunctionalProperty>. ?s ?p ?o} LIMIT 100`);
  return response;
}

export async function getPropertySubjects(propertyId: EntityId, lang: string, limit: number, entityId?: EntityId) {
  const result = await sparqlQuery(propertySubjectsQueryMalware(propertyId, lang, entityId, limit));

  return result.map((binding) => {
    return { entityId: entityValue(binding.p),
      label: binding.pLabel.value,
    }
  })
}

function propertySubjectsQueryMalware(propertyId: EntityId,
                               object?: EntityId,
                               limit?: number,
                               resultVariable = 'p'): string {
  const obj = (object
      ? `${object}`
      : '[]')
  const limitClause = limit ? ` LIMIT ${limit} ` : ''

  return `SELECT ?${resultVariable} WHERE {{
  SELECT DISTINCT ?${resultVariable} WHERE {
    ?${resultVariable} ${propertyId} ${obj} .
  }${limitClause}}}`
}
